<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom's Dice RPG - Fixed Reset</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-wood: #3e2723;
            --parchment: #fdf5e6;
            --parchment-shadow: #d7ccc8;
            --soft-gold: #ffca28;
            --soft-red: #ef5350;
            --dark-ink: #4e342e;
            --velvet-red: #8a1c1c;
        }

        body {
            font-family: 'Cinzel', serif;
            background: radial-gradient(circle, #5d4037 0%, #21120e 100%);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px; color: var(--dark-ink);
        }

        .main-wrapper {
            display: flex; gap: 25px; max-width: 1100px; width: 100%; align-items: flex-start;
        }

        /* --- CARD STYLE --- */
        .card {
            background: var(--parchment);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 
                inset 0 0 40px rgba(161, 136, 127, 0.4), 
                0 20px 40px rgba(0,0,0,0.5),             
                0 0 0 6px #5d4037;                       
            position: relative;
            border: none;
        }

        /* HISTORY PANEL */
        .history-panel { 
            flex: 1; min-width: 280px; max-height: 700px; 
            display: flex; flex-direction: column; 
            background: linear-gradient(to bottom, #fff8e1, #ffe0b2);
            border-radius: 20px 20px 50px 50px; 
        }
        .history-title {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.8em; text-align: center; 
            color: #5d4037; margin-bottom: 15px; 
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
        }

        .log-list { 
            flex-grow: 1; overflow-y: auto; padding-right: 8px; 
            scrollbar-width: thin; scrollbar-color: #8d6e63 transparent;
        }

        .log-entry {
            padding: 12px 15px; margin-bottom: 10px; 
            background: rgba(255,255,255,0.6);
            border-radius: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 0.85em; display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; border: 1px solid rgba(0,0,0,0.05);
        }
        .log-entry.dmg-deal { color: #2e7d32; background: #e8f5e9; }
        .log-entry.dmg-take { color: #c62828; background: #ffebee; }
        .log-entry.chest { color: #6a1b9a; background: #f3e5f5; }
        .log-entry.win { color: #f57f17; background: #fffde7; border: 1px solid #fbc02d; }
        .log-entry.draw { color: #555; background: #eee; }
        
        .round-badge { 
            font-size: 0.75em; background: #8d6e63; color: white; 
            padding: 3px 8px; border-radius: 10px; margin-right: 8px; 
        }

        /* GAME PANEL */
        .game-panel { flex: 2; }
        .game-panel.boss-mode { 
            box-shadow: 0 0 0 6px #7b1fa2, 0 0 50px rgba(123, 31, 162, 0.5); 
        }

        /* HEADER */
        .battle-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; 
            background: rgba(93, 64, 55, 0.1); 
            padding: 20px; border-radius: 25px;
        }
        .fighter-stat { flex: 1; text-align: center; }
        .fighter-name { font-family: 'MedievalSharp'; font-size: 1.5em; color: #3e2723; margin-bottom: 8px; }
        
        .vs-divider { 
            font-family: 'MedievalSharp'; font-size: 1.8em; color: #8d6e63; margin: 0 20px; 
            background: white; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* BARRE VITA */
        .hp-bar-container {
            width: 100%; height: 20px; 
            background: #d7ccc8; border-radius: 15px; 
            overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
        }
        .hp-fill { 
            height: 100%; border-radius: 15px;
            background: linear-gradient(90deg, #42a5f5, #1e88e5); 
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.4);
        }
        .hp-fill.enemy { background: linear-gradient(90deg, #ef5350, #c62828); }

        /* STATS & COMBO */
        .stats-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding: 0 10px;
        }
        .gold-display { 
            font-size: 1.4em; font-weight: bold; color: #f9a825; 
            background: #fff8e1; padding: 5px 15px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #ffe0b2;
        }

        /* COMBO FLAMES */
        .combo-flames { font-size: 1.5em; }
        .combo-flame {
            display: inline-block; opacity: 0.2; filter: grayscale(100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .combo-flame.active {
            opacity: 1; filter: grayscale(0%) drop-shadow(0 0 6px rgba(255, 111, 0, 0.8));
            transform: scale(1.4) translateY(-2px);
        }
        .combo-text { font-family: 'MedievalSharp'; color: #c62828; font-size: 0.9em; margin-top: 5px; font-weight: bold; }

        /* CHEST PROGRESS */
        .chest-progress-container {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            background: rgba(93, 64, 55, 0.85); color: white;
            padding: 8px 25px; border-radius: 50px; 
            margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: fit-content; margin-left: auto; margin-right: auto;
        }
        .chest-dots { display: flex; flex-direction: row; gap: 8px; }
        .chest-dot { width: 12px; height: 12px; background: #4e342e; border-radius: 50%; transition: 0.3s; border: 1px solid rgba(255,255,255,0.2); }
        .chest-dot.active { background: #00e676; box-shadow: 0 0 8px #00e676; transform: scale(1.3); border-color: white; }

        /* NEGOZIO */
        .shop-section { display: flex; gap: 20px; margin-bottom: 30px; }
        .shop-item {
            flex: 1; 
            background: white; border-radius: 20px;
            padding: 15px; text-align: center; cursor: pointer; transition: 0.2s;
            box-shadow: 0 5px 15px rgba(93, 64, 55, 0.15);
            border: 2px solid transparent;
        }
        .shop-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(93, 64, 55, 0.2); }
        .shop-item.active { border-color: #42a5f5; background: #e3f2fd; }
        
        .item-emoji { font-size: 2em; margin-bottom: 5px; display: block; }
        .item-price { font-weight: bold; color: #fbc02d; font-family: 'Cinzel'; }
        .item-desc { font-size: 0.75em; color: #8d6e63; display: block; margin-top: 2px; }

        /* DADI */
        .dadi-area { display: flex; justify-content: center; gap: 50px; margin: 30px 0; min-height: 120px; }
        .dado-wrapper { text-align: center; position: relative; }
        .dado {
            width: 100px; height: 100px; 
            background: #fff3e0; border-radius: 35px;
            display: flex; align-items: center; justify-content: center; 
            font-size: 3em; font-family: 'MedievalSharp'; color: #5d4037;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15), inset 0 -5px 0 rgba(0,0,0,0.1);
            transition: transform 0.5s; z-index: 1; position: relative;
        }
        .dado.boss-dado { background: #f3e5f5; color: #7b1fa2; }
        
        /* ETICHETTA TIPO DADO */
        .dice-label {
            position: absolute; bottom: -25px; left: 0; right: 0;
            font-size: 0.8em; color: #8d6e63; font-weight: bold;
        }

        .marker {
            position: absolute; width: 36px; height: 36px; border-radius: 50%; 
            display: none; align-items: center; justify-content: center;
            font-size: 1em; font-weight: bold; color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 10;
            border: 3px solid white;
        }
        .marker.potion { top: -10px; right: -10px; background: #8e24aa; }
        .marker.shield { top: -10px; left: -10px; background: #1976d2; }
        
        .status-icon {
            position: absolute; bottom: -45px; width: 100%; text-align: center;
            display: none; justify-content: center; gap: 8px;
        }
        .mini-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; color: white; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* PULSANTI */
        .actions-area { min-height: 100px; display: flex; gap: 20px; align-items: center; padding: 10px 0; }
        
        .btn-style {
            flex: 1; padding: 18px; 
            font-family: 'MedievalSharp', cursive; font-size: 1.3em; 
            color: #fff; border: none; border-radius: 50px;
            cursor: pointer; position: relative;
            text-shadow: 0 2px 2px rgba(0,0,0,0.3);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .btn-style:hover { transform: translateY(-3px); box-shadow: 0 12px 20px rgba(0,0,0,0.25); }
        .btn-style:active { transform: translateY(2px); box-shadow: 0 4px 5px rgba(0,0,0,0.2); }

        .btn-attack { background: linear-gradient(to bottom, #ef5350, #c62828); }
        .btn-open { background: linear-gradient(to bottom, #ab47bc, #7b1fa2); }
        .btn-ignore { background: linear-gradient(to bottom, #78909c, #546e7a); }

        .chest-actions { display: none; width: 100%; gap: 15px; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* MODALI */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(62, 39, 35, 0.8); z-index: 100;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: #fff8e1; width: 90%; max-width: 420px;
            border-radius: 40px; padding: 40px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            border: 8px solid #ffca28;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* MODALE LIVELLO EROE */
        .level-up-card {
            background: linear-gradient(135deg, #fff59d 0%, #fbc02d 100%);
            border: 15px solid var(--velvet-red);
            width: 90%; max-width: 450px;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: var(--dark-ink);
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.3), 
                0 0 50px 10px rgba(255, 193, 7, 0.5); 
            animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .level-badge-large {
            font-size: 4em; display: block; margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }
        
        .rewards-box {
            background: rgba(255,255,255,0.6); 
            padding: 15px; border-radius: 15px; 
            margin-bottom: 25px; 
            border: 2px solid rgba(138, 28, 28, 0.1);
        }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .reward-icon-container {
            width: 110px; height: 110px; background: white;
            border-radius: 50%; margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5em; box-shadow: 0 10px 20px rgba(255, 202, 40, 0.3);
        }
        .reward-title { font-family: 'MedievalSharp'; font-size: 1.8em; margin-bottom: 10px; color: #5d4037; }
        .reward-desc { color: #8d6e63; margin-bottom: 25px; line-height: 1.5; font-weight: bold; }
        
        .btn-modal {
            background: linear-gradient(to bottom, #66bb6a, #43a047); color: white; 
            padding: 15px; border-radius: 30px; border: none;
            font-family: 'MedievalSharp'; font-size: 1.2em; 
            cursor: pointer; width: 100%; transition: 0.2s;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        .btn-modal:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        .btn-velvet {
            background: linear-gradient(to bottom, #8a1c1c, #630f0f);
            box-shadow: 0 5px 15px rgba(138, 28, 28, 0.5);
            border: 2px solid #ffca28;
            color: #ffca28;
        }

        .btn-bonus { background: linear-gradient(to bottom, #fdd835, #fbc02d); color: #5d4037; }
        
        /* OVERLAY GAME OVER */
        .overlay-gameover {
            position: absolute; top:0; left:0; right:0; bottom:0; 
            background: rgba(33, 18, 14, 0.95);
            border-radius: 30px; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; color: white;
            text-align: center; padding: 20px;
        }

        .report-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            width: 80%;
            border: 1px solid rgba(255,255,255,0.2);
            text-align: left;
        }
        .report-line {
            display: flex; justify-content: space-between;
            font-size: 1.1em; margin-bottom: 10px;
            font-family: 'Cinzel', serif;
            color: #d7ccc8;
        }
        .report-val { color: #ffca28; font-weight: bold; }

    </style>
</head>
<body>

<div class="main-wrapper">
    
    <!-- SINISTRA -->
    <div class="card history-panel">
        <div class="history-title">Cronache del Regno</div>
        <div class="log-list" id="logList"></div>
    </div>

    <!-- DESTRA -->
    <div class="card game-panel" id="gamePanel">
        
        <div style="text-align:center; margin-bottom:15px; font-family:'MedievalSharp'; font-size:1.6em; color:#7b1fa2; display:none; text-shadow: 0 2px 10px rgba(123, 31, 162, 0.3);" id="bossAlert">üëπ SCONTRO LEGGENDARIO</div>

        <div class="battle-header">
            <div class="fighter-stat">
                <div class="fighter-name" id="heroNameDisplay">
                    Eroe <span style="font-size:0.7em; color:#8d6e63; margin-left:5px;">Lv.1</span>
                </div>
                <div class="hp-bar-container"><div class="hp-fill" id="hpBarPlayer" style="width: 100%;"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:0.8em; margin-top:8px; font-weight:bold; color:#6d4c41;">
                    <span><span id="hpPlayer">25</span>/<span id="hpMaxPlayer">25</span> PV</span>
                    <span>Turno: <span id="roundCounter">1</span></span>
                </div>
            </div>
            <div class="vs-divider">VS</div>
            <div class="fighter-stat">
                <div class="fighter-name" id="enemyName">Nemico</div>
                <div class="hp-bar-container"><div class="hp-fill enemy" id="hpBarEnemy" style="width: 100%;"></div></div>
                <div style="font-size:0.8em; margin-top:8px; font-weight:bold; color:#6d4c41;"><span id="hpEnemy">20</span>/<span id="hpMaxEnemy">20</span> PV</div>
            </div>
        </div>

        <div class="stats-row">
            <div class="gold-display">üí∞ <span id="gold">50</span></div>
            <div class="combo-container">
                <div class="combo-flames">
                    <span class="combo-flame">üî•</span>
                    <span class="combo-flame">üî•</span>
                    <span class="combo-flame">üî•</span>
                    <span class="combo-flame">üî•</span>
                    <span class="combo-flame">üî•</span>
                </div>
                <div class="combo-text" id="comboText">COMBO ATTIVA!</div>
            </div>
        </div>

        <!-- PROGRESSO SCRIGNO -->
        <div class="chest-progress-container">
            <span style="font-weight:bold; font-size:0.9em;">Scrigno:</span>
            <div class="chest-dots">
                <div class="chest-dot" id="dot1"></div>
                <div class="chest-dot" id="dot2"></div>
                <div class="chest-dot" id="dot3"></div>
                <div class="chest-dot" id="dot4"></div>
                <div class="chest-dot" id="dot5"></div>
            </div>
        </div>

        <div class="shop-section">
            <div class="shop-item" id="shopPotion" onclick="buyItem('potion')">
                <span class="item-emoji">üß™</span>
                <span class="item-price">30 üí∞</span>
                <span class="item-desc">+2 Tocco Magico</span>
            </div>
            <div class="shop-item" id="shopShield" onclick="buyItem('shield')">
                <span class="item-emoji">üõ°Ô∏è</span>
                <span class="item-price">25 üí∞</span>
                <span class="item-desc">Egida Divina</span>
            </div>
        </div>

        <div class="dadi-area">
            <div class="dado-wrapper">
                <div class="dado" id="dadoPlayer">?</div>
                <div class="dice-label" id="diceLabelPlayer">1d6</div>
                <div id="markerPotion" class="marker potion">+2</div>
                <div id="markerShield" class="marker shield">üõ°Ô∏è</div>
                <div class="status-icon" id="statusContainer">
                    <div id="statusMirror" class="mini-icon" style="background:#42a5f5;">ü™û</div>
                    <div id="statusVine" class="mini-icon" style="background:#66bb6a;">üåø</div>
                    <div id="statusPower" class="mini-icon" style="background:#ef5350;">‚öîÔ∏è</div>
                </div>
            </div>
            <div class="dado-wrapper">
                <div class="dado" id="dadoEnemy">?</div>
                <div class="dice-label" id="diceLabelEnemy">1d6</div>
            </div>
        </div>

        <div class="actions-area">
            <button class="btn-style btn-attack" id="btnAttack" onclick="combatTurn()">‚öîÔ∏è Attacco</button>
            <div class="chest-actions" id="chestActions">
                <button class="btn-style btn-open" onclick="openChest()">üéÅ Apri</button>
                <button class="btn-style btn-ignore" onclick="ignoreChest()">Ignora</button>
            </div>
        </div>

        <div class="overlay-gameover" id="overlay">
            <div style="font-family:'MedievalSharp'; font-size:3em; color:#ef5350; margin-bottom:10px;">SCONFITTA</div>
            <p style="margin-bottom:20px; font-size:1.1em; color:#d7ccc8;">Il tuo viaggio termina qui...</p>
            
            <div class="report-box">
                <div class="report-line"><span>Eroe Livello:</span> <span class="report-val" id="endLevel">1</span></div>
                <div class="report-line"><span>Monete Totali:</span> <span class="report-val" id="endGold">0</span></div>
                <div class="report-line"><span>Round Sopravvissuti:</span> <span class="report-val" id="endRounds">0</span></div>
            </div>

            <button class="btn-style" onclick="initGame()" style="width:auto; padding:15px 50px; background:#5d4037;">Nuova Avventura</button>
        </div>

    </div>
</div>

<!-- MODALI -->
<div class="modal-overlay" id="chestModal">
    <div class="modal-content">
        <div class="reward-icon-container">
            <span id="rewardEmoji">‚ùì</span>
        </div>
        <div class="reward-title" id="rewardTitle">Titolo</div>
        <div class="reward-desc" id="rewardDesc">Descrizione</div>
        <button class="btn-modal" onclick="closeChestModal()">Raccogli</button>
    </div>
</div>

<div class="modal-overlay" id="levelUpModal">
    <div class="modal-content">
        <div class="reward-icon-container" style="border-color:#66bb6a; box-shadow: 0 10px 20px rgba(102, 187, 106, 0.3);">
            <span>üèÜ</span>
        </div>
        <div class="reward-title" id="levelUpTitle">GLORIA!</div>
        <div class="reward-desc" id="levelUpDesc">Hai trionfato! La tua vitalit√† √® rinnovata.</div>
        
        <button id="btnBonusChest" class="btn-modal btn-bonus" onclick="openLevelBonus()">
            üéÅ Cerca Tesori
        </button>
        
        <button id="btnNextLevel" class="btn-modal" style="display:none;" onclick="nextLevel()">
            Avanza ‚ûî
        </button>
    </div>
</div>

<!-- NUOVO MODALE PASSAGGIO LIVELLO EROE -->
<div class="modal-overlay" id="heroLevelModal">
    <div class="level-up-card">
        <div style="font-family:'MedievalSharp'; font-size:2em; color:#8a1c1c; margin-bottom:10px;">GLORIA ETERNA!</div>
        <span class="level-badge-large">‚öúÔ∏è</span>
        <div style="font-size:1.4em; font-weight:bold; margin-bottom:15px;">SEI PASSATO AL</div>
        <div style="font-family:'MedievalSharp'; font-size:3.5em; color:#8a1c1c; margin-bottom:20px;">LIVELLO <span id="heroLvlNum">2</span></div>
        
        <div class="rewards-box">
            <div style="color: #f57f17; font-weight:bold; font-size: 1.2em; margin-bottom: 8px;">
                üí∞ Trovate <span id="lvlGold">0</span> Monete!
            </div>
            <div style="color: #2e7d32; font-weight:bold; font-size: 1.2em;">
                üíö Hai guadagnato <span id="lvlHeal">0</span> PV
            </div>
            <div style="font-size:0.8em; color:#8d6e63; margin-top:5px;">(70% della tua salute attuale)</div>
        </div>

        <button class="btn-modal btn-velvet" onclick="closeHeroLevelModal()">CONTINUA L'AVVENTURA</button>
    </div>
</div>

<script>
    // --- SETUP GLOBALE ---
    let hpPlayer, maxHpPlayer, hpEnemy, maxHpEnemy, gold, level, streak, chestCount, round, totalRounds;
    let heroLevel = 1;
    let items = { potion: false, shield: false };
    let nextTurnMultiplier = 1; 
    let mirrorEffect = false;
    let vineTrap = false;

    // --- CONFIGURAZIONE NEMICI ---
    function getEnemyStats(lvl) {
        if (lvl === 1) return { hp: 20, die: 6 };
        if (lvl === 2) return { hp: 30, die: 6 };
        if (lvl === 3) return { hp: 40, die: 8 }; // Boss
        if (lvl === 4) return { hp: 45, die: 8 };
        if (lvl === 5) return { hp: 45, die: 10 };
        if (lvl === 6) return { hp: 50, die: 10 }; // Boss
        
        // > Livello 6: +10 PV per livello, dado diventa d12
        return { hp: 50 + ((lvl - 6) * 10), die: 12 };
    }

    // --- CONFIGURAZIONE EROE ---
    function getHeroStats(lvl) {
        if (lvl === 1) return { maxHp: 25, die: 6 };
        if (lvl === 2) return { maxHp: 30, die: 6 };
        if (lvl === 3) return { maxHp: 35, die: 8 };
        if (lvl === 4) return { maxHp: 40, die: 8 };
        if (lvl === 5) return { maxHp: 45, die: 10 };
        if (lvl === 6) return { maxHp: 50, die: 10 };
        
        // > Livello 6: +5 PV per livello, dado resta d10
        return { maxHp: 50 + ((lvl - 6) * 5), die: 10 };
    }

    function initGame() {
        // 1. Reset variabili numeriche
        gold = 50; level = 1; streak = 0; chestCount = 0;
        totalRounds = 1; 
        heroLevel = 1;

        // 2. Reset statistiche Eroe
        let stats = getHeroStats(1);
        maxHpPlayer = stats.maxHp;
        hpPlayer = maxHpPlayer;

        // 3. Reset Items & Effetti
        items = { potion: false, shield: false };
        resetEffects(); 

        // 4. Reset Interfaccia (PULIZIA TOTALE)
        document.getElementById('logList').innerHTML = '';
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('heroLevelModal').style.display = 'none';
        document.getElementById('chestModal').style.display = 'none';
        
        // 5. Ripristino pulsanti (CRUCIALE)
        document.getElementById('btnAttack').style.display = 'block';
        document.getElementById('btnAttack').disabled = false;
        document.getElementById('chestActions').style.display = 'none';

        // 6. Reset visivo items e start
        updateShopUI(); 
        updateMarkers();
        startNewLevel(true); 
        updateUI();
    }

    function resetEffects() {
        nextTurnMultiplier = 1; mirrorEffect = false; vineTrap = false; updateStatusIcons();
    }

    function startNewLevel(isFirst) {
        // Boss ogni 3 livelli
        let isBoss = (level % 3 === 0);
        
        let eStats = getEnemyStats(level);
        maxHpEnemy = eStats.hp;
        hpEnemy = maxHpEnemy;

        // Visualizza dado nemico
        document.getElementById('diceLabelEnemy').textContent = `1d${eStats.die}`;

        // Reset HP completi solo quando si cambia nemico (livello di gioco)
        if (!isFirst) hpPlayer = maxHpPlayer; 
        
        round = 1;

        document.getElementById('enemyName').textContent = isBoss ? "BOSS ANCIENT" : `Nemico Lv.${level}`;
        
        const panel = document.getElementById('gamePanel');
        const alert = document.getElementById('bossAlert');
        
        if(isBoss) { 
            panel.classList.add('boss-mode'); 
            alert.style.display = 'block'; 
        } else { 
            panel.classList.remove('boss-mode'); 
            alert.style.display = 'none'; 
        }
        updateUI();
    }

    // --- LOGICA LIVELLO EROE ---
    function checkHeroLevel() {
        let calculatedLevel = Math.floor((totalRounds - 1) / 20) + 1;
        
        if (calculatedLevel > heroLevel) {
            
            // 1. Salva HP attuali prima dell'upgrade
            let currentHp = hpPlayer;

            // 2. Aumenta Livello e Max HP
            heroLevel = calculatedLevel;
            let newStats = getHeroStats(heroLevel);
            maxHpPlayer = newStats.maxHp;

            // 3. ORO
            let foundGold = Math.floor(Math.random() * 50) + 50; 
            gold += foundGold;

            // 4. CURA STRATEGICA (70% dei PV ATTUALI)
            let healAmount = Math.floor(currentHp * 0.7); 
            
            // Applica cura ma non superare il nuovo massimo
            hpPlayer = Math.min(maxHpPlayer, currentHp + healAmount);

            showHeroLevelModal(heroLevel, foundGold, healAmount);
        }
        
        // Aggiorna etichetta Nome
        document.getElementById('heroNameDisplay').innerHTML = `Eroe <span style="font-size:0.7em; color:#8d6e63; margin-left:5px;">Lv.${heroLevel}</span>`;
        
        // Aggiorna etichetta Dadi Eroe
        let hStats = getHeroStats(heroLevel);
        document.getElementById('diceLabelPlayer').textContent = `1d${hStats.die}`;
    }

    function showHeroLevelModal(lvl, g, h) {
        document.getElementById('heroLvlNum').innerText = lvl;
        document.getElementById('lvlGold').innerText = g;
        document.getElementById('lvlHeal').innerText = h;
        document.getElementById('heroLevelModal').style.display = 'flex';
    }

    function closeHeroLevelModal() {
        document.getElementById('heroLevelModal').style.display = 'none';
        updateUI();
    }

    // --- COMBAT ---
    function combatTurn() {
        document.getElementById('btnAttack').disabled = true;
        document.getElementById('dadoPlayer').textContent = '...'; 
        document.getElementById('dadoEnemy').textContent = '...';
        setTimeout(resolveCombat, 600);
    }

    function resolveCombat() {
        // Dati attuali
        let hStats = getHeroStats(heroLevel);
        let eStats = getEnemyStats(level);

        // Tiro Eroe (Singolo dado aggiornato)
        let rollP = Math.floor(Math.random() * hStats.die) + 1;

        // Tiro Nemico
        let rollE = Math.floor(Math.random() * eStats.die) + 1;

        if (vineTrap) { rollP = 0; vineTrap = false; updateStatusIcons(); }
        if (items.potion && rollP > 0) { rollP += 2; items.potion = false; }

        document.getElementById('dadoPlayer').textContent = rollP;
        document.getElementById('dadoEnemy').textContent = rollE;
        updateShopUI(); updateMarkers();

        let difference = Math.abs(rollP - rollE);

        if (rollP > rollE) {
            streak++; 
            chestCount = Math.min(5, chestCount + 1);
            
            let mult = 1;
            if (streak >= 5) mult = 4; else if (streak >= 3) mult = 1.5;
            
            if (nextTurnMultiplier > 1) { mult *= nextTurnMultiplier; nextTurnMultiplier = 1; updateStatusIcons(); }

            let dmg = Math.floor(difference * mult);
            hpEnemy -= dmg; gold += dmg;
            
            let comboMsg = mult > 1 ? ` (Critico x${mult})` : "";
            addLog("Inflitto", `-${dmg} PV${comboMsg}`, "dmg-deal");

        } else if (rollP < rollE) {
            streak = 0;
            if (mirrorEffect) {
                hpEnemy -= difference; mirrorEffect = false; updateStatusIcons();
                addLog("Specchio Arcano", `Rifletti ${difference}`, "chest");
            } else {
                let dmg = difference;
                if (items.shield) { 
                    dmg = 0; items.shield = false; 
                    updateShopUI(); updateMarkers();
                    addLog("Egida Divina", "Colpo Parato!", "chest");
                }
                hpPlayer -= dmg;
                if(dmg > 0) addLog("Colpito", `-${dmg} PV`, "dmg-take");
            }
        } else {
            streak = 0; addLog("Schivata", " - ", "draw");
        }

        round++; 
        totalRounds++;
        checkHeroLevel();

        updateUI();
        if (checkWin()) return;

        if (chestCount >= 5) {
            document.getElementById('btnAttack').style.display = 'none';
            document.getElementById('chestActions').style.display = 'flex';
        } else {
            document.getElementById('btnAttack').disabled = false;
        }
    }

    // --- CHEST & MODALS ---
    function openChest() {
        chestCount = 0;
        let rand = Math.random() * 100;
        let t, d, e;

        if (rand < 50) { 
            let g = Math.floor(Math.random() * 30) + 30; gold += g;
            t = "Antico Tesoro"; d = `Hai trovato +${g} Monete d'Oro`; e = "üí∞";
        } 
        else if (rand < 75) { 
            nextTurnMultiplier = 2; t = "Furia Cieca"; d = "Il prossimo attacco infligge danno DOPPIO"; e = "‚öîÔ∏è";
        } 
        else if (rand < 85) { 
            nextTurnMultiplier = 3; t = "Potere Divino"; d = "Il prossimo attacco infligge danno TRIPLO"; e = "‚ö°";
        } 
        else if (rand < 95) { 
            mirrorEffect = true; t = "Specchio Magico"; d = "Rifletti il prossimo danno subito al nemico"; e = "ü™û";
        } 
        else { 
            vineTrap = true; t = "Radici Maledette"; d = "Sei bloccato. Il tuo prossimo tiro sar√† 0."; e = "üåø";
        }

        showChestReward(t, d, e);
        updateStatusIcons(); updateUI();
        document.getElementById('chestActions').style.display = 'none';
        document.getElementById('btnAttack').style.display = 'block';
    }

    function showChestReward(t, d, e) {
        document.getElementById('rewardTitle').textContent = t;
        document.getElementById('rewardDesc').textContent = d;
        document.getElementById('rewardEmoji').textContent = e;
        document.getElementById('chestModal').style.display = 'flex';
    }
    function closeChestModal() { 
        document.getElementById('chestModal').style.display = 'none'; 
        document.getElementById('btnAttack').disabled = false;
    }
    function ignoreChest() {
        chestCount = 0; updateUI();
        document.getElementById('chestActions').style.display = 'none';
        document.getElementById('btnAttack').style.display = 'block';
        document.getElementById('btnAttack').disabled = false;
    }

    // --- WIN / LEVEL UP ---
    function checkWin() {
        if (hpEnemy <= 0) {
            hpEnemy = 0; updateUI();
            addLog("Vittoria", "Livello Completato", "win");
            setTimeout(showLevelUpModal, 500);
            return true;
        }
        if (hpPlayer <= 0) {
            // POPOLAMENTO REPORT FINALE
            document.getElementById('endLevel').textContent = heroLevel;
            document.getElementById('endGold').textContent = gold;
            document.getElementById('endRounds').textContent = totalRounds - 1;

            document.getElementById('overlay').style.display = 'flex';
            return true;
        }
        return false;
    }

    function showLevelUpModal() {
        document.getElementById('levelUpTitle').textContent = "GLORIA!";
        document.getElementById('levelUpDesc').textContent = "Il nemico √® caduto. Sei pronto per la prossima sfida?";
        document.getElementById('btnBonusChest').style.display = 'inline-block';
        document.getElementById('btnNextLevel').style.display = 'none';
        document.getElementById('levelUpModal').style.display = 'flex';
    }

    function openLevelBonus() {
        let bonusGold = Math.floor(Math.random() * 30) + 20; 
        gold += bonusGold;
        document.getElementById('levelUpTitle').textContent = `+${bonusGold} ORO`;
        document.getElementById('levelUpDesc').textContent = "Hai saccheggiato il nemico!";
        document.getElementById('btnBonusChest').style.display = 'none';
        document.getElementById('btnNextLevel').style.display = 'inline-block';
        updateUI();
    }

    function nextLevel() {
        level++; document.getElementById('levelUpModal').style.display = 'none';
        startNewLevel(); document.getElementById('btnAttack').disabled = false;
    }

    // --- UTILS ---
    function buyItem(type) {
        let cost = type === 'potion' ? 30 : 25;
        if(gold >= cost && !items[type]) { 
            gold -= cost; items[type] = true; updateShopUI(); updateMarkers(); updateUI(); 
        }
    }

    function updateMarkers() {
        document.getElementById('markerPotion').style.display = items.potion ? 'flex' : 'none';
        document.getElementById('markerShield').style.display = items.shield ? 'flex' : 'none';
    }

    function updateStatusIcons() {
        document.getElementById('statusMirror').style.display = mirrorEffect ? 'flex' : 'none';
        document.getElementById('statusVine').style.display = vineTrap ? 'flex' : 'none';
        document.getElementById('statusPower').style.display = nextTurnMultiplier > 1 ? 'flex' : 'none';
        const anyActive = mirrorEffect || vineTrap || nextTurnMultiplier > 1;
        document.getElementById('statusContainer').style.display = anyActive ? 'flex' : 'none';
    }

    function updateShopUI() {
        const set = (id, active) => { 
            const el = document.getElementById(id); 
            active ? el.classList.add('active') : el.classList.remove('active'); 
            const priceEl = el.querySelector('.item-price');
            priceEl.textContent = active ? "ATTIVO" : (id === 'shopPotion' ? '30 üí∞' : '25 üí∞');
        };
        set('shopPotion', items.potion); set('shopShield', items.shield);
    }

    function updateUI() {
        document.getElementById('hpBarPlayer').style.width = `${(hpPlayer/maxHpPlayer)*100}%`;
        document.getElementById('hpPlayer').textContent = Math.max(0, hpPlayer);
        document.getElementById('hpMaxPlayer').textContent = maxHpPlayer;
        
        let percentage = (hpEnemy / maxHpEnemy) * 100;
        document.getElementById('hpBarEnemy').style.width = `${percentage}%`;
        document.getElementById('hpEnemy').textContent = Math.max(0, hpEnemy);
        document.getElementById('hpMaxEnemy').textContent = maxHpEnemy; 

        document.getElementById('gold').textContent = gold;
        document.getElementById('roundCounter').textContent = round;
        
        for(let i=1; i<=5; i++) {
            let dot = document.getElementById(`dot${i}`);
            i <= chestCount ? dot.classList.add('active') : dot.classList.remove('active');
        }

        const flames = document.querySelectorAll('.combo-flame');
        const txt = document.getElementById('comboText');
        flames.forEach((f,i) => {
            if(i < streak) f.classList.add('active'); else f.classList.remove('active');
        });
        if (streak >= 3) {
            txt.style.display = 'block';
            if (streak >= 5) txt.textContent = "COMBO MASSIMA (x4)";
            else if (streak >= 4) txt.textContent = "COMBO DOPPIA (x2)";
            else txt.textContent = "COMBO (x1.5)";
        } else {
            txt.style.display = 'none';
        }

        // Assicurati che le etichette dadi siano aggiornate anche al resize o refresh UI
        let hStats = getHeroStats(heroLevel);
        document.getElementById('diceLabelPlayer').textContent = `1d${hStats.die}`;
    }

    function addLog(t, v, c) {
        const l = document.getElementById('logList');
        const e = document.createElement('div');
        e.className = `log-entry ${c}`;
        e.innerHTML = `<div><span class="round-badge">#${totalRounds}</span><span>${t}</span></div><strong>${v}</strong>`;
        l.insertBefore(e, l.firstChild);
    }

    initGame();
</script>
</body>
</html>
